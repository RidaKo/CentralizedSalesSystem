@inherits LayoutComponentBase
@implements IDisposable
@using CentralizedSalesSystem.Frontend.Services
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject ITokenStore TokenStore
@inject NavigationManager Navigation
@inject BusinessContext BusinessContext

<MudThemeProvider IsDarkMode="true" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudText Typo="Typo.h6">Centralized Sales</MudText>
        <MudSpacer />
        @if (IsAuthenticated)
        {
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudButton Color="Color.Inherit"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.AccountCircle">
                        @UserEmail
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/profile"))">
                        Profile
                    </MudMenuItem>
                    <MudMenuItem OnClick="@LogoutAsync">
                        Logout
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
        else
        {
            <MudButton Href="/login"
                       Variant="Variant.Outlined"
                       Color="Color.Inherit"
                       StartIcon="@Icons.Material.Filled.Login">
                Login
            </MudButton>
        }
    </MudAppBar>

    @if (ShowSidebar)
    {
        <MudDrawer Open="false" Variant="DrawerVariant.Mini">
            <MudNavMenu>
                <AuthorizeView>
                    @if ((BusinessContext.IsOwner || BusinessContext.IsSuper) && BusinessContext.BusinessId.HasValue)
                    {
                        <MudNavLink Href="/manager/dashboard" Icon="@Icons.Material.Filled.BusinessCenter">Manager Dashboard</MudNavLink>
                        <MudNavLink Href="@($"/manager/business/{BusinessContext.BusinessId.Value}")" Icon="@Icons.Material.Filled.ManageAccounts">
                            Business Management
                        </MudNavLink>
                    }
                </AuthorizeView>
                <AuthorizeView>
                    @if (BusinessContext.IsRestaurantEnabled)
                    {
                        <MudNavLink Href="/employee/restaurant" Icon="@Icons.Material.Filled.RestaurantMenu">Restaurant Portal</MudNavLink>
                    }
                    @if (BusinessContext.IsBeautyEnabled)
                    {
                        <MudNavLink Href="/employee/beauty" Icon="@Icons.Material.Filled.Spa">Beauty Portal</MudNavLink>
                    }
                </AuthorizeView>
            </MudNavMenu>
        </MudDrawer>
    }

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code{

    private ClaimsPrincipal CurrentUser { get; set; } = new(new ClaimsIdentity());

    private bool IsAuthenticated => CurrentUser.Identity?.IsAuthenticated ?? false;

    private string? UserEmail =>
        CurrentUser.FindFirst(ClaimTypes.Email)?.Value
        ?? CurrentUser.FindFirst("email")?.Value
        ?? CurrentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value
        ?? CurrentUser.FindFirst("sub")?.Value;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        BusinessContext.Changed += OnBusinessContextChanged;
        await LoadUserAsync();
        await BusinessContext.EnsureLoadedAsync();
        RedirectEmployeeHomeIfNeeded();
    }

    private async Task LoadUserAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        CurrentUser = state.User ?? new ClaimsPrincipal(new ClaimsIdentity());
        await InvokeAsync(StateHasChanged);
    }

    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        _ = ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        await LoadUserAsync();
        await BusinessContext.RefreshAsync();
        RedirectEmployeeHomeIfNeeded();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LogoutAsync()
    {
        await TokenStore.ClearTokenAsync();

        if (AuthStateProvider is ApiAuthStateProvider apiAuthStateProvider)
        {
            apiAuthStateProvider.NotifyUserLoggedOut();
        }

        BusinessContext.Reset();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        BusinessContext.Changed -= OnBusinessContextChanged;
    }

    private void OnBusinessContextChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private bool IsEmployeeOnly =>
        (CurrentUser.IsInRole("Employee") || CurrentUser.Claims.Any(c => c.Type == ClaimTypes.Role && c.Value == "Employee"))
        && !CurrentUser.IsInRole("Admin");

    private bool ShowSidebar => !IsEmployeeOnly;

    private void RedirectEmployeeHomeIfNeeded()
    {
        if (!IsEmployeeOnly)
        {
            return;
        }

        var relative = Navigation.ToBaseRelativePath(Navigation.Uri);
        if (!string.IsNullOrEmpty(relative))
        {
            return;
        }

        if (BusinessContext.IsBeautyEnabled)
        {
            Navigation.NavigateTo("/employee/beauty");
        }
        else if (BusinessContext.IsRestaurantEnabled)
        {
            Navigation.NavigateTo("/employee/restaurant");
        }
    }
}
