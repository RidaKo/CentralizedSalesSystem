@page "/manager/business/{BusinessId:long}"
@using CentralizedSalesSystem.Frontend.Models
@using CentralizedSalesSystem.Frontend.Services
@using CentralizedSalesSystem.Frontend.Json
@using Microsoft.AspNetCore.Authorization
@using System.Linq
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject BusinessContext BusinessContext

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudStack Spacing="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           Color="Color.Default"
                           OnClick="GoToDashboard" />
            <MudText Typo="Typo.h4">Business Management</MudText>
            <MudSpacer />
        </MudStack>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-6" />
        }
        else if (_business == null)
        {
            <MudAlert Severity="Severity.Error">Business not found.</MudAlert>
        }
        else
        {
            <MudGrid GutterSpacing="3">
                @if (!_isBusinessEditing)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudStack Spacing="1">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.h5">@_business?.Name</MudText>
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small">@_business?.SubscriptionPlan</MudChip>
                                    <MudSpacer />
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               OnClick="BeginBusinessEdit">
                                        Edit
                                    </MudButton>
                                </MudStack>
                                <MudText Typo="Typo.body1">@_business?.Address</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@_business?.Email | @_business?.Phone</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Currency: @_business?.Currency</MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12" md="7">
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudStack Spacing="1">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.h5">Business details</MudText>
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small">@_business?.SubscriptionPlan</MudChip>
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Update the profile information for this business.
                                </MudText>

                                <MudGrid GutterSpacing="2">
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_businessForm.Name" Label="Name" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_businessForm.Phone" Label="Phone" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_businessForm.Address" Label="Address" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_businessForm.Email" Label="Email" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" sm="3">
                                        <MudSelect T="Currency" @bind-Value="_businessForm.Currency" Label="Currency">
                                            <MudSelectItem Value="@Currency.EUR">EUR</MudSelectItem>
                                            <MudSelectItem Value="@Currency.USD">USD</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12" sm="3">
                                        <MudSelect T="SubscriptionPlan" @bind-Value="_businessForm.SubscriptionPlan" Label="Plan">
                                            <MudSelectItem Value="@SubscriptionPlan.Catering">Catering</MudSelectItem>
                                            <MudSelectItem Value="@SubscriptionPlan.Beauty">Beauty</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                </MudGrid>

                                <MudStack Row="true" Spacing="1">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               Disabled="_isSavingBusiness"
                                               OnClick="SaveBusinessAsync">
                                        @(_isSavingBusiness ? "Saving..." : "Save Business")
                                    </MudButton>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Default"
                                               StartIcon="@Icons.Material.Filled.Refresh"
                                               Disabled="_isSavingBusiness"
                                               OnClick="ResetBusinessForm">
                                        Cancel
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-5" />

            <MudTabs @bind-ActivePanelIndex="_tabIndex" Rounded="true" Elevation="2" PanelClass="pa-4">
                <MudTabPanel Text="Employees" Icon="@Icons.Material.Filled.People">
                    @EmployeesTab()
                </MudTabPanel>
                <MudTabPanel Text="Discounts" Icon="@Icons.Material.Filled.LocalOffer">
                    @DiscountsTab()
                </MudTabPanel>
                <MudTabPanel Text="Taxes" Icon="@Icons.Material.Filled.RequestQuote">
                    @TaxesTab()
                </MudTabPanel>
                <MudTabPanel Text="Items" Icon="@Icons.Material.Filled.Inventory">
                    @ItemsTab()
                </MudTabPanel>
                <MudTabPanel Text="Tips" Icon="@Icons.Material.Filled.MonetizationOn">
                    @TipsTab()
                </MudTabPanel>
                <MudTabPanel Text="Tables" Icon="@Icons.Material.Filled.TableRestaurant">
                    @TablesTab()
                </MudTabPanel>
            </MudTabs>
        }
    </MudStack>
</MudContainer>

@code {
    [Parameter] public long BusinessId { get; set; }

    private Business? _business;
    private BusinessEditModel _businessForm = new();
    private bool _isLoading = true;
    private int _tabIndex;

    private readonly List<EmployeeDto> _employees = new();
    private readonly List<Discount> _discounts = new();
    private readonly List<Tax> _taxes = new();
    private readonly List<ItemDto> _items = new();
    private readonly List<TableDto> _tables = new();
    private readonly List<OrderDto> _orders = new();

    private EmployeeFormModel _employeeForm = new();
    private DiscountEditModel _discountForm = new();
    private TaxEditModel _taxForm = new();
    private ItemEditModel _itemForm = new();
    private TableEditModel _tableForm = new();

    private string _employeeSearch = string.Empty;
    private string _discountSearch = string.Empty;
    private string _taxSearch = string.Empty;
    private string _itemSearch = string.Empty;
    private string _tableSearch = string.Empty;
    private string _tipSearch = string.Empty;

    private bool _isSavingBusiness;
    private bool _isSavingEmployee;
    private bool _isSavingDiscount;
    private bool _isSavingTax;
    private bool _isSavingItem;
    private bool _isSavingTable;

    private bool _isBusinessEditing;
    private bool IsEditingBusiness => _business?.Id == _businessForm.Id && _businessForm.Id != 0;
    private bool IsEditingEmployee => _employeeForm.Id != 0;
    private bool IsEditingDiscount => _discountForm.Id != 0;
    private bool IsEditingTax => _taxForm.Id != 0;
    private bool IsEditingItem => _itemForm.Id != 0;
    private bool IsEditingTable => _tableForm.Id != 0;

    protected override async Task OnInitializedAsync()
    {
        await InitializeAsync();
    }

    private void GoToDashboard() => Navigation.NavigateTo("/manager/dashboard");

    private async Task InitializeAsync()
    {
        try
        {
            _isLoading = true;
            await BusinessContext.EnsureLoadedAsync();

            var isSameBusiness = BusinessContext.BusinessId.HasValue && BusinessContext.BusinessId.Value == BusinessId;
            var hasAccess = BusinessContext.IsSuper || (BusinessContext.IsOwner && isSameBusiness);
            if (!hasAccess)
            {
                Snackbar.Add("Only the business owner or a super admin can access this page.", Severity.Error);
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }

            await LoadBusinessAsync();
            await Task.WhenAll(LoadEmployeesAsync(), LoadDiscountsAsync(), LoadTaxesAsync(), LoadItemsAsync(), LoadTablesAsync(), LoadOrdersAsync());

            InitializeBusinessForm();
            BeginCreateEmployee();
            BeginCreateDiscount();
            BeginCreateTax();
            BeginCreateItem();
            BeginCreateTable();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to load business page: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadBusinessAsync()
    {
        var response = await Http.GetAsync($"businesses/{BusinessId}");
        if (response.IsSuccessStatusCode)
        {
            _business = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<Business>(response.Content);
            if (BusinessContext.IsSuper && _business is not null)
            {
                BusinessContext.AssumeBusiness(_business.Id, _business.SubscriptionPlan);
            }
            InitializeBusinessForm();
        }
        else
        {
            Snackbar.Add($"Failed to load business: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
        }
    }

    private Task LoadDiscountsAsync() =>
        LoadCollectionAsync($"discounts?filterByBusinessId={BusinessId}&limit=200", _discounts, "discounts");

    private Task LoadTaxesAsync() =>
        LoadCollectionAsync($"taxes?filterByBusinessId={BusinessId}&limit=200", _taxes, "taxes");

    private Task LoadItemsAsync() =>
        LoadCollectionAsync($"items?filterByBusinessId={BusinessId}&limit=200", _items, "items");

    private Task LoadTablesAsync() =>
        LoadCollectionAsync($"tables?filterByBusinessId={BusinessId}&limit=200", _tables, "tables");

    private async Task LoadOrdersAsync()
    {
        try
        {
            _orders.Clear();
            const int pageSize = 200;
            var page = 1;

            while (true)
            {
                var response = await Http.GetAsync($"orders?filterByBusinessId={BusinessId}&page={page}&limit={pageSize}");
                if (!response.IsSuccessStatusCode)
                {
                    var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                    Snackbar.Add($"Failed to load orders: {reason}", Severity.Error);
                    break;
                }

                var payload = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<PaginatedResponse<OrderDto>>(response.Content);
                if (payload?.Data != null)
                {
                    _orders.AddRange(payload.Data);
                }

                if (payload == null || payload.TotalPages <= page)
                {
                    break;
                }

                page++;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to load orders: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var response = await Http.GetAsync($"users?filterByBusinessId={BusinessId}&limit=200");
            if (response.IsSuccessStatusCode)
            {
                var payload = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<PaginatedResponse<UserResponseDto>>(response.Content);
                _employees.Clear();
                if (payload?.Data != null)
                {
                    _employees.AddRange(payload.Data.Select(MapToEmployee));
                }
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Failed to load employees: {reason}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to load employees: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadCollectionAsync<T>(string endpoint, List<T> target, string label)
    {
        var response = await Http.GetAsync(endpoint);
        if (response.IsSuccessStatusCode)
        {
            var payload = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<PaginatedResponse<T>>(response.Content);
            target.Clear();
            if (payload?.Data != null) target.AddRange(payload.Data);
        }
        else
        {
            Snackbar.Add($"Failed to load {label}: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
        }
    }

    private void InitializeBusinessForm()
    {
        if (_business is null) return;

        _businessForm = new BusinessEditModel
        {
            Id = _business.Id,
            Name = _business.Name,
            Phone = _business.Phone,
            Address = _business.Address,
            Email = _business.Email,
            Currency = _business.Currency,
            SubscriptionPlan = _business.SubscriptionPlan
        };
        _isBusinessEditing = false;
    }

    private void BeginBusinessEdit() => _isBusinessEditing = true;

    private void ResetBusinessForm()
    {
        InitializeBusinessForm();
        _isBusinessEditing = false;
    }

    private async Task SaveBusinessAsync()
    {
        if (string.IsNullOrWhiteSpace(_businessForm.Name) ||
            string.IsNullOrWhiteSpace(_businessForm.Phone) ||
            string.IsNullOrWhiteSpace(_businessForm.Address) ||
            string.IsNullOrWhiteSpace(_businessForm.Email))
        {
            Snackbar.Add("Name, phone, address, and email are required.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingBusiness = true;

            var payload = new BusinessUpdateRequest
            {
                Name = _businessForm.Name,
                Phone = _businessForm.Phone,
                Address = _businessForm.Address,
                Email = _businessForm.Email,
                Currency = _businessForm.Currency,
                SubscriptionPlan = _businessForm.SubscriptionPlan
            };

            var request = new HttpRequestMessage(HttpMethod.Patch, $"businesses/{BusinessId}")
            {
                Content = System.Net.Http.Json.JsonContent.Create(payload)
            };

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<Business>(response.Content);
                if (record is not null)
                {
                    _business = record;
                    InitializeBusinessForm();
                    if (BusinessContext.IsSuper)
                    {
                        BusinessContext.AssumeBusiness(record.Id, record.SubscriptionPlan);
                    }
                }
                Snackbar.Add("Business updated.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Unable to update business: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to update business: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingBusiness = false;
            _isBusinessEditing = false;
        }
    }

    // Employees
    private void BeginCreateEmployee()
    {
        _employeeForm = new EmployeeFormModel
        {
            Id = 0,
            Name = string.Empty,
            Email = string.Empty,
            Phone = string.Empty,
            Password = string.Empty,
            Activity = "active"
        };
    }

    private void BeginEditEmployee(EmployeeDto employee)
    {
        _tabIndex = 0;
        _employeeForm = new EmployeeFormModel
        {
            Id = employee.Id,
            Name = employee.Name,
            Email = employee.Email,
            Phone = employee.Phone,
            Password = string.Empty,
            Activity = employee.Status
        };
    }

    private async Task SaveEmployeeAsync()
    {
        if (string.IsNullOrWhiteSpace(_employeeForm.Name) ||
            string.IsNullOrWhiteSpace(_employeeForm.Email) ||
            (!IsEditingEmployee && string.IsNullOrWhiteSpace(_employeeForm.Password)))
        {
            Snackbar.Add("Name, email, and password are required.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingEmployee = true;
            HttpResponseMessage response;

            if (_employeeForm.Id == 0)
            {
                var payload = new UserCreateRequest
                {
                    BusinessId = BusinessId,
                    Name = _employeeForm.Name,
                    Email = _employeeForm.Email,
                    Phone = _employeeForm.Phone ?? string.Empty,
                    Password = _employeeForm.Password ?? string.Empty,
                    Activity = string.IsNullOrWhiteSpace(_employeeForm.Activity) ? "active" : _employeeForm.Activity.ToLowerInvariant()
                };

                response = await HttpJsonDefaultsExtensions.PostAsJsonAsync(Http, "users", payload);
            }
            else
            {
                var payload = new UserPatchRequest
                {
                    Name = _employeeForm.Name,
                    Email = _employeeForm.Email,
                    Phone = _employeeForm.Phone,
                    Activity = string.IsNullOrWhiteSpace(_employeeForm.Activity) ? null : _employeeForm.Activity.ToLowerInvariant(),
                    Password = string.IsNullOrWhiteSpace(_employeeForm.Password) ? null : _employeeForm.Password
                };

                var request = new HttpRequestMessage(HttpMethod.Patch, $"users/{_employeeForm.Id}")
                {
                    Content = System.Net.Http.Json.JsonContent.Create(payload)
                };
                response = await Http.SendAsync(request);
            }

            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<UserResponseDto>(response.Content);
                if (record != null)
                {
                    var mapped = MapToEmployee(record);
                    Upsert(_employees, mapped, e => e.Id == mapped.Id);
                    Snackbar.Add(IsEditingEmployee ? "Employee updated." : "Employee added.", Severity.Success);
                    BeginCreateEmployee();
                }
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Unable to save employee: {reason}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to save employee: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingEmployee = false;
        }
    }

    private async Task DeleteEmployeeAsync(EmployeeDto employee)
    {
        try
        {
            var response = await Http.DeleteAsync($"users/{employee.Id}");
            if (response.IsSuccessStatusCode)
            {
                _employees.Remove(employee);
                Snackbar.Add($"Deleted {employee.Name}", Severity.Success);
                if (_employeeForm.Id == employee.Id) BeginCreateEmployee();
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Failed to delete {employee.Name}: {reason}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {employee.Name}: {ex.Message}", Severity.Error);
        }
    }

    private bool EmployeeFilter(EmployeeDto employee)
    {
        if (string.IsNullOrWhiteSpace(_employeeSearch)) return true;
        return employee.Name.Contains(_employeeSearch, StringComparison.OrdinalIgnoreCase)
            || employee.Email.Contains(_employeeSearch, StringComparison.OrdinalIgnoreCase);
    }

    private static EmployeeDto MapToEmployee(UserResponseDto user) => new()
    {
        Id = user.Id,
        Name = user.Name ?? user.Email,
        Email = user.Email,
        Phone = user.Phone ?? string.Empty,
        Role = "Staff",
        Status = user.Activity?.ToLowerInvariant() ?? "inactive"
    };

    private RenderFragment EmployeesTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">@((IsEditingEmployee ? "Edit" : "New") + " Employee")</MudText>
                        <MudChip T="string"
                                 Color="@(IsEditingEmployee ? Color.Warning : Color.Success)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(IsEditingEmployee ? "Editing" : "Create")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Add staff to this business or update their details.
                    </MudText>

                    <MudTextField @bind-Value="_employeeForm.Name" Label="Name" Required="true" />
                    <MudTextField @bind-Value="_employeeForm.Email" Label="Email" Required="true" />
                    <MudTextField @bind-Value="_employeeForm.Phone" Label="Phone" />
                    <MudTextField @bind-Value="_employeeForm.Password"
                                  Label="@(IsEditingEmployee ? "New Password (optional)" : "Password")"
                                  InputType="InputType.Password"
                                  Required="@(!IsEditingEmployee)" />
                    <MudSelect T="string" @bind-Value="_employeeForm.Activity" Label="Status">
                        <MudSelectItem Value="@("active")">Active</MudSelectItem>
                        <MudSelectItem Value="@("inactive")">Inactive</MudSelectItem>
                    </MudSelect>

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_isSavingEmployee"
                                   OnClick="SaveEmployeeAsync">
                            @(_isSavingEmployee
                                ? "Saving..."
                                : IsEditingEmployee
                                    ? "Update Employee"
                                    : "Add Employee")
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="_isSavingEmployee"
                                   OnClick="BeginCreateEmployee">
                            Clear
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Class="pa-3 pb-1" Elevation="1">
                <MudTable Items="_employees" Hover="true" Dense="true" Striped="true" Filter="EmployeeFilter">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h6">Employees</MudText>
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                                @_employees.Count
                            </MudChip>
                        </MudStack>
                        <MudSpacer />
                        <MudTextField @bind-Value="_employeeSearch"
                                      Placeholder="Search name or email"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Class="mt-0" />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Size="Size.Small"
                                   Class="ma-0 px-3"
                                   OnClick="BeginCreateEmployee">
                            New
                        </MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Phone</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh Style="text-align:right">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.Name</MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Phone">@context.Phone</MudTd>
                        <MudTd DataLabel="Status">
                            <MudText Color="@(context.Status == "active" ? Color.Success : Color.Error)" Typo="Typo.body2">
                                @(context.Status == "active" ? "Active" : "Inactive")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align:right">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => BeginEditEmployee(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteEmployeeAsync(context))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2" Class="pa-4">No employees yet. Add one on the left.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>;

    private RenderFragment DiscountsTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">@((IsEditingDiscount ? "Edit" : "New") + " Discount")</MudText>
                        <MudChip T="string"
                                 Color="@(IsEditingDiscount ? Color.Warning : Color.Success)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(IsEditingDiscount ? "Editing" : "Create")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Build percentage or fixed promotions and choose where they apply.
                    </MudText>

                    <MudTextField @bind-Value="_discountForm.Name" Label="Name" Required="true" />
                    <MudNumericField T="decimal"
                                     @bind-Value="_discountForm.Rate"
                                     Label="Rate"
                                     Adornment="Adornment.End"
                                     AdornmentText="@(_discountForm.Type == DiscountType.Percentage ? "%" : "Amount")" />
                    <MudSelect @bind-Value="_discountForm.Type" Label="Type">
                        <MudSelectItem Value="@DiscountType.Percentage">Percentage</MudSelectItem>
                        <MudSelectItem Value="@DiscountType.Fixed">Fixed</MudSelectItem>
                    </MudSelect>
                    <MudSelect @bind-Value="_discountForm.AppliesTo" Label="Applies To">
                        <MudSelectItem Value="@DiscountAppliesTo.Order">Order</MudSelectItem>
                        <MudSelectItem Value="@DiscountAppliesTo.Product">Product</MudSelectItem>
                        <MudSelectItem Value="@DiscountAppliesTo.Service">Service</MudSelectItem>
                    </MudSelect>
                    <MudSelect @bind-Value="_discountForm.Status" Label="Status">
                        <MudSelectItem Value="@DiscountStatus.Active">Active</MudSelectItem>
                        <MudSelectItem Value="@DiscountStatus.Inactive">Inactive</MudSelectItem>
                    </MudSelect>
                    <MudDatePicker T="DateTime?"
                                   @bind-Date="_discountForm.ValidFrom"
                                   Label="Valid From" />
                    <MudDatePicker T="DateTime?"
                                   @bind-Date="_discountForm.ValidTo"
                                   Label="Valid To (optional)"
                                   Clearable="true" />

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_isSavingDiscount"
                                   OnClick="SaveDiscountAsync">
                            @(_isSavingDiscount
                                ? "Saving..."
                                : IsEditingDiscount
                                    ? "Update Discount"
                                    : "Save Discount")
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="_isSavingDiscount"
                                   OnClick="BeginCreateDiscount">
                            Clear
                        </MudButton>
                    </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudPaper Class="pa-3 pb-1" Elevation="1">
                    <MudTable Items="_discounts" Hover="true" Dense="true" Striped="true" Filter="DiscountFilter">
                        <ToolBarContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6">Discounts</MudText>
                                <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                                    @_discounts.Count
                                </MudChip>
                            </MudStack>
                            <MudSpacer />
                            <MudTextField @bind-Value="_discountSearch"
                                          Placeholder="Search name, type, or scope"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Class="mt-0" />
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Size="Size.Small"
                                       Class="ma-0 px-3"
                                       OnClick="@BeginCreateDiscount">
                                New
                            </MudButton>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Rate</MudTh>
                            <MudTh>Valid</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh Style="text-align:right">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudText Typo="Typo.body2">@context.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Type - @context.AppliesTo</MudText>
                            </MudTd>
                            <MudTd DataLabel="Rate">@FormatDiscountRate(context)</MudTd>
                            <MudTd DataLabel="Valid">@FormatDateRange(context.ValidFrom, context.ValidTo)</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@(context.Status == DiscountStatus.Active ? Color.Success : Color.Default)" Size="Size.Small">@context.Status</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Actions" Style="text-align:right">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => BeginEditDiscount(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteDiscountAsync(context))" />
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Typo="Typo.body2" Class="pa-4">No discounts yet. Start by creating one on the left.</MudText>
                        </NoRecordsContent>
                        <PagerContent>
                            <MudTablePager />
                        </PagerContent>
                    </MudTable>
                </MudPaper>
            </MudItem>
        </MudGrid>;

    private RenderFragment TaxesTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">@((IsEditingTax ? "Edit" : "New") + " Tax")</MudText>
                        <MudChip T="string"
                                 Color="@(IsEditingTax ? Color.Warning : Color.Success)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(IsEditingTax ? "Editing" : "Create")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Maintain tax rates and effective windows.
                    </MudText>

                    <MudTextField @bind-Value="_taxForm.Name" Label="Name" Required="true" />
                    <MudNumericField T="decimal"
                                     @bind-Value="_taxForm.Rate"
                                     Label="Rate (%)"
                                     Adornment="Adornment.End"
                                     AdornmentText="%" />
                    <MudSelect @bind-Value="_taxForm.Status" Label="Status">
                        <MudSelectItem Value="@TaxStatus.Active">Active</MudSelectItem>
                        <MudSelectItem Value="@TaxStatus.Inactive">Inactive</MudSelectItem>
                    </MudSelect>
                    <MudDatePicker T="DateTime?"
                                   @bind-Date="_taxForm.EffectiveFrom"
                                   Label="Effective From" />
                    <MudDatePicker T="DateTime?"
                                   @bind-Date="_taxForm.EffectiveTo"
                                   Label="Effective To (optional)"
                                   Clearable="true" />

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_isSavingTax"
                                   OnClick="SaveTaxAsync">
                            @(_isSavingTax
                                ? "Saving..."
                                : IsEditingTax
                                    ? "Update Tax"
                                    : "Save Tax")
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="_isSavingTax"
                                   OnClick="BeginCreateTax">
                            Clear
                        </MudButton>
                    </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudPaper Class="pa-3 pb-1" Elevation="1">
                    <MudTable Items="_taxes" Hover="true" Dense="true" Striped="true" Filter="TaxFilter">
                        <ToolBarContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6">Taxes</MudText>
                                <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                                    @_taxes.Count
                                </MudChip>
                            </MudStack>
                            <MudSpacer />
                            <MudTextField @bind-Value="_taxSearch"
                                          Placeholder="Search name or status"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Class="mt-0" />
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Size="Size.Small"
                                       Class="ma-0 px-3"
                                       OnClick="@BeginCreateTax">
                                New
                            </MudButton>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Rate</MudTh>
                            <MudTh>Effective</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh Style="text-align:right">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudText Typo="Typo.body2">@context.Name</MudText>
                            </MudTd>
                            <MudTd DataLabel="Rate">@FormatTaxRate(context)</MudTd>
                            <MudTd DataLabel="Effective">@FormatDateRange(context.EffectiveFrom, context.EffectiveTo)</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@(context.Status == TaxStatus.Active ? Color.Success : Color.Default)" Size="Size.Small">@context.Status</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Actions" Style="text-align:right">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => BeginEditTax(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteTaxAsync(context))" />
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Typo="Typo.body2" Class="pa-4">No taxes configured yet. Add one on the left.</MudText>
                        </NoRecordsContent>
                        <PagerContent>
                            <MudTablePager />
                        </PagerContent>
                    </MudTable>
                </MudPaper>
            </MudItem>
        </MudGrid>;

    private RenderFragment ItemsTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">@((IsEditingItem ? "Edit" : "New") + " Item")</MudText>
                        <MudChip T="string"
                                 Color="@(IsEditingItem ? Color.Warning : Color.Success)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(IsEditingItem ? "Editing" : "Create")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Create products and services with default taxes.
                    </MudText>

                    <MudTextField @bind-Value="_itemForm.Name" Label="Name" Required="true" />
                    <MudTextField @bind-Value="_itemForm.Description" Label="Description" Lines="3" />
                    <MudSelect @bind-Value="_itemForm.Type" Label="Type">
                        <MudSelectItem Value="@ItemType.Product">Product</MudSelectItem>
                        <MudSelectItem Value="@ItemType.Service">Service</MudSelectItem>
                    </MudSelect>
                    <MudNumericField T="decimal"
                                     @bind-Value="_itemForm.Price"
                                     Label="Price"
                                     Adornment="Adornment.End"
                                     AdornmentText="@(_business?.Currency.ToString())" />
                    <MudNumericField T="int" @bind-Value="_itemForm.Stock" Label="Stock" Min="0" />
                    <MudSelect T="long?"
                               @bind-Value="_itemForm.TaxId"
                               Label="Tax"
                               Disabled="@(!_taxes.Any())">
                        <MudSelectItem T="long?" Value="@((long?)null)">No tax</MudSelectItem>
                        @foreach (var tax in _taxes.OrderBy(t => t.Name))
                        {
                            <MudSelectItem T="long?" Value="@tax.Id">@($"{tax.Name} ({FormatTaxRate(tax)})")</MudSelectItem>
                        }
                    </MudSelect>

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_isSavingItem"
                                   OnClick="SaveItemAsync">
                            @(_isSavingItem
                                ? "Saving..."
                                : IsEditingItem
                                    ? "Update Item"
                                    : "Save Item")
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="_isSavingItem"
                                   OnClick="BeginCreateItem">
                            Clear
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Class="pa-3 pb-1" Elevation="1">
                <MudTable Items="_items" Hover="true" Dense="true" Striped="true" Filter="ItemFilter">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h6">Items</MudText>
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                                @_items.Count
                            </MudChip>
                        </MudStack>
                        <MudSpacer />
                        <MudTextField @bind-Value="_itemSearch"
                                      Placeholder="Search name or type"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Class="mt-0" />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Size="Size.Small"
                                   Class="ma-0 px-3"
                                   OnClick="BeginCreateItem">
                            New
                        </MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Price</MudTh>
                        <MudTh>Tax</MudTh>
                        <MudTh>Stock</MudTh>
                        <MudTh Style="text-align:right">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">
                            <MudText Typo="Typo.body2">@context.Name</MudText>
                            @if (!string.IsNullOrWhiteSpace(context.Description))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Type">@context.Type</MudTd>
                        <MudTd DataLabel="Price">@FormatItemPrice(context.Price)</MudTd>
                        <MudTd DataLabel="Tax">@GetTaxLabel(context.TaxId)</MudTd>
                        <MudTd DataLabel="Stock">@context.Stock</MudTd>
                        <MudTd DataLabel="Actions" Style="text-align:right">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => BeginEditItem(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteItemAsync(context))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2" Class="pa-4">No items yet. Add one on the left.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>;

    private RenderFragment TipsTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">Tip Summary</MudText>
                        <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                            @TipOrders.Count
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Tips collected on orders for this business.
                    </MudText>
                    <MudDivider Class="my-2" />
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Total tips</MudText>
                        <MudText Typo="Typo.h5">@FormatCurrency(TipsTotal)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Average per employee (@_employees.Count)</MudText>
                        <MudText Typo="Typo.h6">@FormatCurrency(TipsPerEmployee)</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Class="pa-3 pb-1" Elevation="1">
                <MudTable Items="TipOrders" Hover="true" Dense="true" Striped="true" Filter="TipFilter">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h6">Tips</MudText>
                        </MudStack>
                        <MudSpacer />
                        <MudTextField @bind-Value="_tipSearch"
                                      Placeholder="Search order, employee, or amount"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Class="mt-0" />
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Order</MudTh>
                        <MudTh>Employee</MudTh>
                        <MudTh>Tip</MudTh>
                        <MudTh>Updated</MudTh>
                        <MudTh>Status</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Order">
                            <MudText Typo="Typo.body2">#@context.Id</MudText>
                        </MudTd>
                        <MudTd DataLabel="Employee">@GetEmployeeName(GetOrderUserId(context))</MudTd>
                        <MudTd DataLabel="Tip">@FormatCurrency(context.Tip ?? 0m)</MudTd>
                        <MudTd DataLabel="Updated">@FormatOrderDate(context.UpdatedAt)</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string"
                                     Color="@(context.Status == OrderStatus.Closed ? Color.Success : Color.Default)"
                                     Size="Size.Small">
                                @context.Status
                            </MudChip>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2" Class="pa-4">No tips recorded yet.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>;

    private RenderFragment TablesTab() => @<MudGrid GutterSpacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle1">@((IsEditingTable ? "Edit" : "New") + " Table")</MudText>
                        <MudChip T="string"
                                 Color="@(IsEditingTable ? Color.Warning : Color.Success)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(IsEditingTable ? "Editing" : "Create")
                        </MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Manage dining tables and seating capacity.
                    </MudText>

                    <MudTextField @bind-Value="_tableForm.Name" Label="Name" Required="true" />
                    <MudNumericField T="int"
                                     @bind-Value="_tableForm.Capacity"
                                     Label="Capacity"
                                     Min="1" />
                    <MudSelect T="TableStatus" @bind-Value="_tableForm.Status" Label="Status">
                        <MudSelectItem Value="@TableStatus.Free">Free</MudSelectItem>
                        <MudSelectItem Value="@TableStatus.Reserved">Reserved</MudSelectItem>
                        <MudSelectItem Value="@TableStatus.Occupied">Occupied</MudSelectItem>
                    </MudSelect>

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_isSavingTable"
                                   OnClick="SaveTableAsync">
                            @(_isSavingTable
                                ? "Saving..."
                                : IsEditingTable
                                    ? "Update Table"
                                    : "Save Table")
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="_isSavingTable"
                                   OnClick="BeginCreateTable">
                            Clear
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Class="pa-3 pb-1" Elevation="1">
                <MudTable Items="_tables" Hover="true" Dense="true" Striped="true" Filter="TableFilter">
                    <ToolBarContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h6">Tables</MudText>
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                                @_tables.Count
                            </MudChip>
                        </MudStack>
                        <MudSpacer />
                        <MudTextField @bind-Value="_tableSearch"
                                      Placeholder="Search name, status, or capacity"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Class="mt-0" />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Size="Size.Small"
                                   Class="ma-0 px-3"
                                   OnClick="BeginCreateTable">
                            New
                        </MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Capacity</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh Style="text-align:right">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.Name</MudTd>
                        <MudTd DataLabel="Capacity">@context.Capacity</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Color="@GetTableStatusColor(context.Status)" Size="Size.Small">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align:right">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => BeginEditTable(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteTableAsync(context))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2" Class="pa-4">No tables configured yet.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>;

    // Tables
    private void BeginCreateTable()
    {
        _tableForm = new TableEditModel
        {
            Id = 0,
            BusinessId = BusinessId,
            Name = string.Empty,
            Capacity = 2,
            Status = TableStatus.Free
        };
    }

    private void BeginEditTable(TableDto table)
    {
        _tabIndex = 5;
        _tableForm = new TableEditModel
        {
            Id = table.Id,
            BusinessId = table.BusinessId,
            Name = table.Name,
            Capacity = table.Capacity,
            Status = table.Status
        };
    }

    private async Task SaveTableAsync()
    {
        if (string.IsNullOrWhiteSpace(_tableForm.Name))
        {
            Snackbar.Add("Name is required.", Severity.Warning);
            return;
        }

        if (_tableForm.Capacity <= 0)
        {
            Snackbar.Add("Capacity must be greater than zero.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingTable = true;
            HttpResponseMessage response;

            if (_tableForm.Id == 0)
            {
                var payload = new TableCreateRequest
                {
                    BusinessId = BusinessId,
                    Name = _tableForm.Name,
                    Capacity = _tableForm.Capacity,
                    Status = _tableForm.Status
                };

                response = await HttpJsonDefaultsExtensions.PostAsJsonAsync(Http, "tables", payload);
            }
            else
            {
                var payload = new TableUpdateRequest
                {
                    Name = _tableForm.Name,
                    Capacity = _tableForm.Capacity,
                    Status = _tableForm.Status
                };

                var request = new HttpRequestMessage(HttpMethod.Patch, $"tables/{_tableForm.Id}")
                {
                    Content = System.Net.Http.Json.JsonContent.Create(payload)
                };
                response = await Http.SendAsync(request);
            }

            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<TableDto>(response.Content);
                if (record != null)
                {
                    Upsert(_tables, record, t => t.Id == record.Id);
                    Snackbar.Add(_tableForm.Id == 0 ? "Table created." : "Table updated.", Severity.Success);
                    BeginCreateTable();
                }
            }
            else
            {
                Snackbar.Add($"Unable to save table: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to save table: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingTable = false;
        }
    }

    private async Task DeleteTableAsync(TableDto table)
    {
        try
        {
            var response = await Http.DeleteAsync($"tables/{table.Id}");
            if (response.IsSuccessStatusCode)
            {
                _tables.Remove(table);
                Snackbar.Add($"Deleted {table.Name}", Severity.Success);
                if (_tableForm.Id == table.Id) BeginCreateTable();
            }
            else
            {
                Snackbar.Add($"Delete failed: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {table.Name}: {ex.Message}", Severity.Error);
        }
    }

    private bool TableFilter(TableDto table)
    {
        if (string.IsNullOrWhiteSpace(_tableSearch)) return true;

        return table.Name.Contains(_tableSearch, StringComparison.OrdinalIgnoreCase)
            || table.Status.ToString().Contains(_tableSearch, StringComparison.OrdinalIgnoreCase)
            || table.Capacity.ToString().Contains(_tableSearch, StringComparison.OrdinalIgnoreCase)
            || table.Id.ToString().Contains(_tableSearch, StringComparison.OrdinalIgnoreCase);
    }

    private static Color GetTableStatusColor(TableStatus status) => status switch
    {
        TableStatus.Free => Color.Success,
        TableStatus.Reserved => Color.Warning,
        TableStatus.Occupied => Color.Error,
        _ => Color.Default
    };

    // Items
    private void BeginCreateItem()
    {
        _itemForm = new ItemEditModel
        {
            Id = 0,
            BusinessId = BusinessId,
            Name = string.Empty,
            Description = string.Empty,
            Price = 0m,
            Stock = 0,
            Type = ItemType.Product,
            TaxId = null
        };
    }

    private void BeginEditItem(ItemDto item)
    {
        _tabIndex = 3;
        _itemForm = new ItemEditModel
        {
            Id = item.Id,
            BusinessId = item.BusinessId,
            Name = item.Name,
            Description = item.Description,
            Price = item.Price,
            Stock = item.Stock,
            Type = item.Type,
            TaxId = item.TaxId
        };
    }

    private async Task SaveItemAsync()
    {
        if (string.IsNullOrWhiteSpace(_itemForm.Name))
        {
            Snackbar.Add("Name is required.", Severity.Warning);
            return;
        }

        if (_itemForm.Price <= 0)
        {
            Snackbar.Add("Price must be greater than zero.", Severity.Warning);
            return;
        }

        if (_itemForm.Stock < 0)
        {
            Snackbar.Add("Stock cannot be negative.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingItem = true;
            HttpResponseMessage response;

            if (_itemForm.Id == 0)
            {
                var payload = new ItemCreateRequest
                {
                    BusinessId = BusinessId,
                    Name = _itemForm.Name,
                    Description = string.IsNullOrWhiteSpace(_itemForm.Description) ? null : _itemForm.Description,
                    Price = _itemForm.Price,
                    Stock = _itemForm.Stock,
                    Type = _itemForm.Type,
                    TaxId = _itemForm.TaxId
                };

                response = await HttpJsonDefaultsExtensions.PostAsJsonAsync(Http, "items", payload);
            }
            else
            {
                var payload = new ItemUpdateRequest
                {
                    Name = _itemForm.Name,
                    Description = string.IsNullOrWhiteSpace(_itemForm.Description) ? null : _itemForm.Description,
                    Price = _itemForm.Price,
                    Stock = _itemForm.Stock,
                    Type = _itemForm.Type,
                    TaxId = _itemForm.TaxId ?? 0
                };

                var request = new HttpRequestMessage(HttpMethod.Patch, $"items/{_itemForm.Id}")
                {
                    Content = System.Net.Http.Json.JsonContent.Create(payload)
                };
                response = await Http.SendAsync(request);
            }

            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<ItemDto>(response.Content);
                if (record != null)
                {
                    Upsert(_items, record, i => i.Id == record.Id);
                    Snackbar.Add(_itemForm.Id == 0 ? "Item created." : "Item updated.", Severity.Success);
                    BeginCreateItem();
                }
            }
            else
            {
                Snackbar.Add($"Unable to save item: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to save item: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingItem = false;
        }
    }

    private async Task DeleteItemAsync(ItemDto item)
    {
        try
        {
            var response = await Http.DeleteAsync($"items/{item.Id}");
            if (response.IsSuccessStatusCode)
            {
                _items.Remove(item);
                Snackbar.Add($"Deleted {item.Name}", Severity.Success);
                if (_itemForm.Id == item.Id) BeginCreateItem();
            }
            else
            {
                Snackbar.Add($"Delete failed: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {item.Name}: {ex.Message}", Severity.Error);
        }
    }

    private bool ItemFilter(ItemDto item)
    {
        if (string.IsNullOrWhiteSpace(_itemSearch)) return true;

        return item.Name.Contains(_itemSearch, StringComparison.OrdinalIgnoreCase)
            || item.Type.ToString().Contains(_itemSearch, StringComparison.OrdinalIgnoreCase)
            || (item.Description ?? string.Empty).Contains(_itemSearch, StringComparison.OrdinalIgnoreCase)
            || item.Price.ToString("0.##").Contains(_itemSearch, StringComparison.OrdinalIgnoreCase)
            || GetTaxLabel(item.TaxId).Contains(_itemSearch, StringComparison.OrdinalIgnoreCase);
    }

    private string FormatItemPrice(decimal price)
    {
        var currency = _business?.Currency.ToString();
        var prefix = string.IsNullOrWhiteSpace(currency) ? string.Empty : $"{currency} ";
        return $"{prefix}{price:0.##}";
    }

    private string GetTaxLabel(long? taxId)
    {
        if (!taxId.HasValue) return "None";
        var tax = _taxes.FirstOrDefault(t => t.Id == taxId.Value);
        return tax == null ? "Unknown" : $"{tax.Name} ({FormatTaxRate(tax)})";
    }

    // Tips
    private IReadOnlyList<OrderDto> TipOrders => _orders
        .Where(order => (order.Tip ?? 0m) > 0m)
        .OrderByDescending(order => order.UpdatedAt ?? DateTimeOffset.MinValue)
        .ToList();

    private decimal TipsTotal => TipOrders.Sum(order => order.Tip ?? 0m);

    private decimal TipsPerEmployee => _employees.Count == 0 ? 0m : TipsTotal / _employees.Count;

    private bool TipFilter(OrderDto order)
    {
        if (string.IsNullOrWhiteSpace(_tipSearch)) return true;

        var term = _tipSearch.Trim();

        if (order.Id.ToString().Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        var employeeName = GetEmployeeName(GetOrderUserId(order));
        if (!string.IsNullOrWhiteSpace(employeeName) && employeeName.Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (order.Status.ToString().Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (order.Tip.HasValue && order.Tip.Value.ToString("0.##").Contains(term, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return false;
    }

    private string GetEmployeeName(long? userId)
    {
        if (!userId.HasValue) return "Unknown";

        var employee = _employees.FirstOrDefault(e => e.Id == userId.Value);
        return employee?.Name ?? $"User {userId.Value}";
    }

    private static long? GetOrderUserId(OrderDto order)
    {
        if (order.UserId != 0)
        {
            return order.UserId;
        }

        return order.CreatedBy;
    }

    private string FormatCurrency(decimal amount) => FormatItemPrice(amount);

    private static string FormatOrderDate(DateTimeOffset? value) =>
        value.HasValue ? value.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "Unknown";

    // Discounts
    private void BeginCreateDiscount()
    {
        _discountForm = new DiscountEditModel
        {
            BusinessId = BusinessId,
            Type = DiscountType.Percentage,
            AppliesTo = DiscountAppliesTo.Order,
            Status = DiscountStatus.Active,
            Rate = 10,
            ValidFrom = DateTime.UtcNow
        };
    }

    private void BeginEditDiscount(Discount discount)
    {
        _tabIndex = 0;
        _discountForm = new DiscountEditModel
        {
            Id = discount.Id,
            BusinessId = discount.BusinessId,
            Name = discount.Name,
            Rate = discount.Rate,
            Type = discount.Type,
            AppliesTo = discount.AppliesTo,
            Status = discount.Status,
            ValidFrom = discount.ValidFrom.UtcDateTime,
            ValidTo = discount.ValidTo?.UtcDateTime
        };
    }

    private async Task SaveDiscountAsync()
    {
        if (string.IsNullOrWhiteSpace(_discountForm.Name))
        {
            Snackbar.Add("Name is required.", Severity.Warning);
            return;
        }

        if (_discountForm.Rate <= 0)
        {
            Snackbar.Add("Rate must be greater than zero.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingDiscount = true;
            HttpResponseMessage response;
            if (_discountForm.Id == 0)
            {
                var payload = new DiscountCreateRequest
                {
                    BusinessId = _discountForm.BusinessId,
                    Name = _discountForm.Name,
                    Rate = _discountForm.Rate,
                    ValidFrom = ToOffsetUtc(_discountForm.ValidFrom),
                    ValidTo = ToOffsetUtcNullable(_discountForm.ValidTo),
                    Type = _discountForm.Type,
                    AppliesTo = _discountForm.AppliesTo,
                    Status = _discountForm.Status
                };

                response = await HttpJsonDefaultsExtensions.PostAsJsonAsync(Http, "discounts", payload);
            }
            else
            {
                var payload = new DiscountUpdateRequest
                {
                    Name = _discountForm.Name,
                    Rate = _discountForm.Rate,
                    ValidFrom = ToOffsetUtc(_discountForm.ValidFrom),
                    ValidTo = ToOffsetUtcNullable(_discountForm.ValidTo),
                    Type = _discountForm.Type,
                    AppliesTo = _discountForm.AppliesTo,
                    Status = _discountForm.Status
                };

                var request = new HttpRequestMessage(HttpMethod.Patch, $"discounts/{_discountForm.Id}")
                {
                    Content = System.Net.Http.Json.JsonContent.Create(payload)
                };
                response = await Http.SendAsync(request);
            }

            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<Discount>(response.Content);
                if (record != null)
                {
                    Upsert(_discounts, record, d => d.Id == record.Id);
                    Snackbar.Add(_discountForm.Id == 0 ? "Discount created." : "Discount updated.", Severity.Success);
                    BeginCreateDiscount();
                }
            }
            else
            {
                Snackbar.Add($"Unable to save discount: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to save discount: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingDiscount = false;
        }
    }

    private async Task DeleteDiscountAsync(Discount discount)
    {
        try
        {
            var response = await Http.DeleteAsync($"discounts/{discount.Id}");
            if (response.IsSuccessStatusCode)
            {
                _discounts.Remove(discount);
                Snackbar.Add($"Deleted {discount.Name}", Severity.Success);
                if (_discountForm.Id == discount.Id) BeginCreateDiscount();
            }
            else
            {
                Snackbar.Add($"Delete failed: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {discount.Name}: {ex.Message}", Severity.Error);
        }
    }

    private bool DiscountFilter(Discount discount)
    {
        if (string.IsNullOrWhiteSpace(_discountSearch)) return true;

        return discount.Name.Contains(_discountSearch, StringComparison.OrdinalIgnoreCase)
            || discount.Type.ToString().Contains(_discountSearch, StringComparison.OrdinalIgnoreCase)
            || discount.AppliesTo.ToString().Contains(_discountSearch, StringComparison.OrdinalIgnoreCase);
    }

    private string FormatDiscountRate(Discount discount)
    {
        if (discount.Type == DiscountType.Percentage)
        {
            return $"{discount.Rate:0.##}%";
        }

        var currency = _business?.Currency.ToString();
        var prefix = string.IsNullOrWhiteSpace(currency) ? string.Empty : $"{currency} ";
        return $"{prefix}{discount.Rate:0.##}";
    }

    // Taxes
    private void BeginCreateTax()
    {
        _taxForm = new TaxEditModel
        {
            BusinessId = BusinessId,
            Name = "New Tax",
            Rate = 5m,
            Status = TaxStatus.Active,
            EffectiveFrom = DateTime.UtcNow
        };
    }

    private void BeginEditTax(Tax tax)
    {
        _tabIndex = 1;
        _taxForm = new TaxEditModel
        {
            Id = tax.Id,
            BusinessId = tax.BusinessId,
            Name = tax.Name,
            Rate = tax.Rate,
            Status = tax.Status,
            EffectiveFrom = tax.EffectiveFrom.UtcDateTime,
            EffectiveTo = tax.EffectiveTo?.UtcDateTime
        };
    }

    private async Task SaveTaxAsync()
    {
        if (string.IsNullOrWhiteSpace(_taxForm.Name))
        {
            Snackbar.Add("Name is required.", Severity.Warning);
            return;
        }

        if (_taxForm.Rate <= 0)
        {
            Snackbar.Add("Rate must be greater than zero.", Severity.Warning);
            return;
        }

        try
        {
            _isSavingTax = true;
            HttpResponseMessage response;
            if (_taxForm.Id == 0)
            {
                var payload = new TaxCreateRequest
                {
                    BusinessId = _taxForm.BusinessId,
                    Name = _taxForm.Name,
                    Rate = _taxForm.Rate,
                    Status = _taxForm.Status,
                    EffectiveFrom = ToOffsetUtc(_taxForm.EffectiveFrom),
                    EffectiveTo = ToOffsetUtcNullable(_taxForm.EffectiveTo)
                };

                response = await HttpJsonDefaultsExtensions.PostAsJsonAsync(Http, "taxes", payload);
            }
            else
            {
                var payload = new TaxUpdateRequest
                {
                    Name = _taxForm.Name,
                    Rate = _taxForm.Rate,
                    Status = _taxForm.Status,
                    EffectiveFrom = ToOffsetUtc(_taxForm.EffectiveFrom),
                    EffectiveTo = ToOffsetUtcNullable(_taxForm.EffectiveTo)
                };

                var request = new HttpRequestMessage(HttpMethod.Patch, $"taxes/{_taxForm.Id}")
                {
                    Content = System.Net.Http.Json.JsonContent.Create(payload)
                };
                response = await Http.SendAsync(request);
            }

            if (response.IsSuccessStatusCode)
            {
                var record = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<Tax>(response.Content);
                if (record != null)
                {
                    Upsert(_taxes, record, t => t.Id == record.Id);
                    Snackbar.Add(_taxForm.Id == 0 ? "Tax created." : "Tax updated.", Severity.Success);
                    BeginCreateTax();
                }
            }
            else
            {
                Snackbar.Add($"Unable to save tax: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to save tax: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingTax = false;
        }
    }

    private async Task DeleteTaxAsync(Tax tax)
    {
        try
        {
            var response = await Http.DeleteAsync($"taxes/{tax.Id}");
            if (response.IsSuccessStatusCode)
            {
                _taxes.Remove(tax);
                Snackbar.Add($"Deleted {tax.Name}", Severity.Success);
                if (_taxForm.Id == tax.Id) BeginCreateTax();
            }
            else
            {
                Snackbar.Add($"Delete failed: {(int)response.StatusCode} {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {tax.Name}: {ex.Message}", Severity.Error);
        }
    }

    private bool TaxFilter(Tax tax)
    {
        if (string.IsNullOrWhiteSpace(_taxSearch)) return true;
        return tax.Name.Contains(_taxSearch, StringComparison.OrdinalIgnoreCase)
            || tax.Status.ToString().Contains(_taxSearch, StringComparison.OrdinalIgnoreCase);
    }

    private static string FormatTaxRate(Tax tax) => $"{tax.Rate:0.##}%";

    private static string FormatDateRange(DateTimeOffset from, DateTimeOffset? to) =>
        to.HasValue ? $"{from:yyyy-MM-dd} - {to.Value:yyyy-MM-dd}" : $"{from:yyyy-MM-dd} onward";

    private static void Upsert<T>(List<T> list, T item, Func<T, bool> predicate)
    {
        var index = list.FindIndex(x => predicate(x));
        if (index >= 0)
        {
            list[index] = item;
        }
        else
        {
            list.Add(item);
        }
    }

    private static DateTimeOffset ToOffsetUtc(DateTime? value)
    {
        var dt = value ?? DateTime.UtcNow;
        var specified = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
        return new DateTimeOffset(specified);
    }

    private static DateTimeOffset? ToOffsetUtcNullable(DateTime? value)
    {
        if (!value.HasValue) return null;
        var specified = DateTime.SpecifyKind(value.Value, DateTimeKind.Utc);
        return new DateTimeOffset(specified);
    }

    private sealed class BusinessEditModel
    {
        public long Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Address { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public Currency Currency { get; set; } = Currency.EUR;
        public SubscriptionPlan SubscriptionPlan { get; set; } = SubscriptionPlan.Catering;
    }

    private sealed class BusinessUpdateRequest
    {
        public string? Name { get; set; }
        public string? Phone { get; set; }
        public string? Address { get; set; }
        public string? Email { get; set; }
        public Currency? Currency { get; set; }
        public SubscriptionPlan? SubscriptionPlan { get; set; }
    }

    private sealed class EmployeeDto
    {
        public long Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Role { get; set; } = "Staff";
        public string Status { get; set; } = "active";
    }

    private sealed class EmployeeFormModel
    {
        public long Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Activity { get; set; } = "active";
    }

    private sealed class UserResponseDto
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string? Name { get; set; }
        public string Email { get; set; } = string.Empty;
        public string? Phone { get; set; }
        public string? Activity { get; set; }
    }

    private sealed class UserCreateRequest
    {
        public long BusinessId { get; set; }
        public string? Name { get; set; }
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Activity { get; set; } = "active";
    }

    private sealed class UserPatchRequest
    {
        public long? BusinessId { get; set; }
        public string? Name { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public string? Activity { get; set; }
        public string? Password { get; set; }
    }

    private sealed class DiscountEditModel
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public decimal Rate { get; set; }
        public DateTime? ValidFrom { get; set; } = DateTime.UtcNow;
        public DateTime? ValidTo { get; set; }
        public DiscountType Type { get; set; } = DiscountType.Percentage;
        public DiscountAppliesTo AppliesTo { get; set; } = DiscountAppliesTo.Order;
        public DiscountStatus Status { get; set; } = DiscountStatus.Active;
    }

    private sealed class DiscountCreateRequest
    {
        public string Name { get; set; } = string.Empty;
        public decimal Rate { get; set; }
        public DateTimeOffset ValidFrom { get; set; }
        public DateTimeOffset? ValidTo { get; set; }
        public DiscountType Type { get; set; }
        public DiscountAppliesTo AppliesTo { get; set; }
        public DiscountStatus Status { get; set; }
        public long BusinessId { get; set; }
    }

    private sealed class DiscountUpdateRequest
    {
        public string? Name { get; set; }
        public decimal? Rate { get; set; }
        public DateTimeOffset? ValidFrom { get; set; }
        public DateTimeOffset? ValidTo { get; set; }
        public DiscountType? Type { get; set; }
        public DiscountAppliesTo? AppliesTo { get; set; }
        public DiscountStatus? Status { get; set; }
    }

    private sealed class TaxEditModel
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public decimal Rate { get; set; }
        public TaxStatus Status { get; set; } = TaxStatus.Active;
        public DateTime? EffectiveFrom { get; set; } = DateTime.UtcNow;
        public DateTime? EffectiveTo { get; set; }
    }

    private sealed class TaxCreateRequest
    {
        public string Name { get; set; } = string.Empty;
        public decimal Rate { get; set; }
        public DateTimeOffset EffectiveFrom { get; set; }
        public DateTimeOffset? EffectiveTo { get; set; }
        public TaxStatus Status { get; set; }
        public long BusinessId { get; set; }
    }

    private sealed class TaxUpdateRequest
    {
        public string? Name { get; set; }
        public decimal? Rate { get; set; }
        public DateTimeOffset? EffectiveFrom { get; set; }
        public DateTimeOffset? EffectiveTo { get; set; }
        public TaxStatus? Status { get; set; }
    }

    private sealed class ItemDto
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public ItemType Type { get; set; } = ItemType.Product;
        public long? TaxId { get; set; }
    }

    private sealed class ItemEditModel
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public ItemType Type { get; set; } = ItemType.Product;
        public long? TaxId { get; set; }
    }

    private sealed class ItemCreateRequest
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public ItemType Type { get; set; }
        public long BusinessId { get; set; }
        public long? TaxId { get; set; }
    }

    private sealed class ItemUpdateRequest
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public decimal? Price { get; set; }
        public int? Stock { get; set; }
        public ItemType? Type { get; set; }
        public long? TaxId { get; set; }
    }

    private sealed class TableDto
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public TableStatus Status { get; set; } = TableStatus.Free;
    }

    private sealed class TableEditModel
    {
        public long Id { get; set; }
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public TableStatus Status { get; set; } = TableStatus.Free;
    }

    private sealed class TableCreateRequest
    {
        public long BusinessId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public TableStatus Status { get; set; } = TableStatus.Free;
    }

    private sealed class TableUpdateRequest
    {
        public string? Name { get; set; }
        public int? Capacity { get; set; }
        public TableStatus? Status { get; set; }
    }
}
