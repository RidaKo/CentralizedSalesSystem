@using CentralizedSalesSystem.Frontend.Models
@using CentralizedSalesSystem.Frontend.Json
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudTable Items="@_discounts" Hover="true" Striped="true" Dense="true" Elevation="0">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Active Discounts</MudText>
        <MudSpacer />
        <!-- Calls the new Async method -->
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateDiscountAsync">
            Add Discount
        </MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Value</MudTh>
        <MudTh>Valid Until</MudTh>
        <MudTh Style="text-align:right">Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Type">
            <MudChip T="string" Color="@(context.Type == DiscountType.Percentage ? Color.Info : Color.Warning)" Size="Size.Small">@context.Type</MudChip>
        </MudTd>
        <MudTd DataLabel="Value">
            @(context.Type == DiscountType.Percentage ? $"{context.Rate}%" : $"${context.Rate}")
        </MudTd>
        <MudTd DataLabel="Valid Until">
            @(context.ValidTo.HasValue ? context.ValidTo.Value.ToString("yyyy-MM-dd") : "Forever")
        </MudTd>
        <MudTd DataLabel="Actions" Style="text-align:right">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await DeleteDiscount(context))" />
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    [Parameter] public long BusinessId { get; set; }
    private List<Discount> _discounts = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync($"discounts?filterByBusinessId={BusinessId}&limit=100");
            if (response.IsSuccessStatusCode)
            {
                var payload = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<PaginatedResponse<Discount>>(response.Content);
                if (payload?.Data != null) _discounts = payload.Data;
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Failed to load discounts: {reason}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to load discounts: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateDiscountAsync()
    {
        var newDiscount = new Discount 
        { 
            BusinessId = BusinessId, 
            Name = "New Promo", 
            Type = DiscountType.Percentage, 
            AppliesTo = DiscountAppliesTo.Order,
            Status = DiscountStatus.Active,
            Rate = 10,
            ValidFrom = DateTimeOffset.UtcNow,
            ValidTo = DateTimeOffset.UtcNow.AddMonths(1)
        };

        try 
        {
            var payload = new DiscountCreateRequest
            {
                BusinessId = newDiscount.BusinessId,
                Name = newDiscount.Name,
                Rate = newDiscount.Rate,
                ValidFrom = newDiscount.ValidFrom,
                ValidTo = newDiscount.ValidTo,
                Type = newDiscount.Type,
                AppliesTo = newDiscount.AppliesTo,
                Status = newDiscount.Status
            };

            var response = await Http.PostAsJsonAsync("discounts", payload);
            
            if (response.IsSuccessStatusCode)
            {
                var created = await HttpJsonDefaultsExtensions.ReadFromJsonAsync<Discount>(response.Content);
                if (created != null)
                {
                    _discounts.Add(created);
                    Snackbar.Add("Discount Saved to Database!", Severity.Success);
                }
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Failed to save discount: {reason}", Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Unable to save discount.", Severity.Error);
        }
    }

    private async Task DeleteDiscount(Discount item)
    {
        try
        {
            var response = await Http.DeleteAsync($"discounts/{item.Id}");
            if (response.IsSuccessStatusCode)
            {
                _discounts.Remove(item);
                Snackbar.Add($"Deleted {item.Name}", Severity.Success);
            }
            else
            {
                var reason = $"{(int)response.StatusCode} {response.ReasonPhrase}";
                Snackbar.Add($"Failed to delete {item.Name}: {reason}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unable to delete {item.Name}: {ex.Message}", Severity.Error);
        }
    }

    private sealed class DiscountCreateRequest
    {
        public string Name { get; set; } = string.Empty;
        public decimal Rate { get; set; }
        public DateTimeOffset ValidFrom { get; set; }
        public DateTimeOffset? ValidTo { get; set; }
        public DiscountType Type { get; set; }
        public DiscountAppliesTo AppliesTo { get; set; }
        public DiscountStatus Status { get; set; }
        public long BusinessId { get; set; }
    }
}
