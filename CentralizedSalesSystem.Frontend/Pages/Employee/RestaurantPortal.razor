@page "/employee/restaurant"
@using CentralizedSalesSystem.Frontend.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.False" Class="employee-portal mt-6">
    <MudText Typo="Typo.h3" Class="mb-1">Work portal</MudText>
    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-4">
        Restaurant employee interface
    </MudText>

    @if (IsLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-6" />
    }
    else
    {
        @if (ActiveView == PortalView.CurrentOrder)
        {
            <MudGrid GutterSize="3">
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="2" Class="pa-3 order-panel">
                        <div class="d-flex align-center justify-space-between mb-2">
                            <div>
                                <MudText Typo="Typo.h6">@CurrentOrderTitle</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Tap menu items to add. Edit is available only for open orders.
                                </MudText>
                            </div>
                            <MudStack Spacing="1" AlignItems="AlignItems.End">
                                <MudChip T="OrderStatus"
                                         Color="@GetStatusColor(ActiveOrder?.Status ?? OrderStatus.Open)"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small">
                                    @(ActiveOrder?.Status ?? OrderStatus.Open)
                                </MudChip>
                                @if (IsEditMode && CanModifyActiveOrder)
                                {
                                    <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" Size="Size.Small">
                                        Editing
                                    </MudChip>
                                }
                            </MudStack>
                        </div>

                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.End" Class="mb-3">
                            <MudSelect T="long?"
                                       Value="SelectedTableForNewOrder"
                                       ValueChanged="OnTableSelectionChanged"
                                       ValueExpression="() => SelectedTableForNewOrder"
                                       Label="Table"
                                       Dense="true"
                                       Class="flex-grow-1">
                                @foreach (var table in Tables)
                                {
                                    <MudSelectItem T="long?" Value="@table.Id">
                                        @table.Name (@table.Status)
                                    </MudSelectItem>
                                }
                            </MudSelect>
                            @if (CanShowNewOrderButton)
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.Add"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           OnClick="CreateOrderFromSelection">
                                    New order
                                </MudButton>
                            }
                        </MudStack>

                        @if (!CanModifyActiveOrder && ActiveOrder is not null)
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                                This order is @ActiveOrder.Status; adding or editing items is disabled.
                            </MudAlert>
                        }

                        <MudList T="OrderItemDto" Dense="true" Class="order-lines mb-3">
                            @if (ActiveOrder?.Items?.Any() == true)
                            {
                                @foreach (var line in ActiveOrder.Items)
                                {
                                    var menuItem = Items.FirstOrDefault(i => i.Id == line.ItemId);
                                    <MudListItem T="OrderItemDto" Class="order-line">
                                        <MudIcon Icon="@Icons.Material.Filled.Fastfood" Color="Color.Primary" Class="mr-2" />
                                        <div class="d-flex flex-column mr-3">
                                            <MudText Typo="Typo.body2">@((menuItem?.Name) ?? "Item")</MudText>
                                            @if (!string.IsNullOrWhiteSpace(line.Notes))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@line.Notes</MudText>
                                            }
                                        </div>
                                        <MudSpacer />
                                        @if (IsEditMode && CanModifyActiveOrder)
                                        {
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle"
                                                               Disabled="@(line.Quantity <= 1)"
                                                               Color="Color.Default"
                                                               Size="Size.Small"
                                                               OnClick="@(() => ChangeQuantity(line, -1))" />
                                                <MudText Typo="Typo.body2">@line.Quantity</MudText>
                                                <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                                               Color="Color.Default"
                                                               Size="Size.Small"
                                                               Disabled="@(line.Quantity >= 10)"
                                                               OnClick="@(() => ChangeQuantity(line, 1))" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Color="Color.Error"
                                                               Size="Size.Small"
                                                               OnClick="@(() => RemoveItem(line))" />
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2">@FormatPrice(line, menuItem)</MudText>
                                        }
                                    </MudListItem>
                                }
                            }
                            else if (ActiveOrder is null)
                            {
                                <MudListItem T="OrderItemDto">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Secondary" Class="mr-2" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Create a new order to add dishes.
                                    </MudText>
                                </MudListItem>
                            }
                            else
                            {
                                <MudListItem T="OrderItemDto">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Secondary" Class="mr-2" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        No items yet. Add dishes to this order.
                                    </MudText>
                                </MudListItem>
                            }
                        </MudList>

                        <MudPaper Elevation="0" Class="pa-2 mb-2 total-line">
                            <MudStack>
                                <div class="d-flex justify-space-between">
                                    <MudText Typo="Typo.caption">Subtotal</MudText>
                                    <MudText Typo="Typo.caption">@Subtotal.ToString("C")</MudText>
                                </div>
                                <div class="d-flex justify-space-between">
                                    <MudText Typo="Typo.caption">Discount (@DiscountPercentLabel)</MudText>
                                    <MudText Typo="Typo.caption">-@DiscountAmount.ToString("C")</MudText>
                                </div>
                                <div class="d-flex justify-space-between">
                                    <MudText Typo="Typo.caption">Tip</MudText>
                                    <MudText Typo="Typo.caption">@ActiveOrder?.Tip.ToString("C")</MudText>
                                </div>
                                <MudDivider Class="my-1" />
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.subtitle2">Total</MudText>
                                    <MudText Typo="Typo.subtitle2">@CurrentOrderTotal.ToString("C")</MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.caption">Paid</MudText>
                                    <MudText Typo="Typo.caption">@TotalPaid.ToString("C")</MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.caption">Remaining</MudText>
                                    <MudText Typo="Typo.caption" Color="@(RemainingToPay > 0 ? Color.Warning : Color.Success)">
                                        @RemainingToPay.ToString("C")
                                    </MudText>
                                </div>
                                @if (ChangeAmount > 0)
                                {
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.caption">Change</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Info">@ChangeAmount.ToString("C")</MudText>
                                    </div>
                                }
                            </MudStack>
                        </MudPaper>

                        <MudGrid GutterSize="2" Class="mt-2">
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null || !CanModifyActiveOrder)"
                                           OnClick="ToggleEdit">
                                    @(IsEditMode ? "Done" : "Edit")
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null)"
                                           OnClick="TogglePayments">
                                    Split bill
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null || !CanModifyActiveOrder)"
                                           OnClick="SendOrder">
                                    Send
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null || !CanModifyActiveOrder)"
                                           OnClick="CancelOrder">
                                    Cancel
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Secondary"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null || !CanModifyActiveOrder)"
                                           OnClick="ToggleDiscount">
                                    Discount
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Info"
                                           FullWidth="true"
                                           Disabled="@(ActiveOrder is null || !CanModifyActiveOrder)"
                                           OnClick="ToggleTip">
                                    Tip
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12">
                                <MudStack Row="true" Spacing="1">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               FullWidth="true"
                                               Disabled="@(ActiveOrder is null || RemainingToPay <= 0 || !CanModifyActiveOrder)"
                                               OnClick="PayOrder">
                                        Pay @if (RemainingToPay > 0) { <span> (@RemainingToPay.ToString("C"))</span> }
                                    </MudButton>
                                    @if (ActiveOrder is not null && !IsOpenStatus(ActiveOrder.Status))
                                    {
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Default"
                                                   FullWidth="true"
                                                   OnClick="@(async () => await ShowReceipt())">
                                            Receipt
                                        </MudButton>
                                    }
                                </MudStack>
                            </MudItem>
                        </MudGrid>

                        @if (ShowDiscountPanel && ActiveOrder is not null && CanModifyActiveOrder)
                        {
                            <MudPaper Elevation="1" Class="pa-2 mt-2">
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudTextField @bind-Value="DiscountInput"
                                                  Label="Discount %"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Percent"
                                                  Dense="true"
                                                  Immediate="true"
                                                  Style="max-width:200px;" />
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="ApplyDiscountAmount">
                                        Apply
                                    </MudButton>
                                    <MudButton Variant="Variant.Text" OnClick="@(() => ShowDiscountPanel = false)">Close</MudButton>
                                </MudStack>
                            </MudPaper>
                        }

                        @if (ShowTipPanel && ActiveOrder is not null && CanModifyActiveOrder)
                        {
                            <MudPaper Elevation="1" Class="pa-2 mt-2">
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.subtitle2" Class="mr-2">Tip</MudText>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="@(() => ApplyTipPercent(0.05m))">5%</MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="@(() => ApplyTipPercent(0.10m))">10%</MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="@(() => ApplyTipPercent(0.15m))">15%</MudButton>
                                    <MudTextField @bind-Value="TipInput"
                                                  Label="Custom tip"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                                  Dense="true"
                                                  Style="max-width:200px;" />
                                    <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="ApplyCustomTip">Set</MudButton>
                                    <MudButton Variant="Variant.Text" OnClick="@(() => ShowTipPanel = false)">Close</MudButton>
                                </MudStack>
                            </MudPaper>
                        }

                        @if (ShowPaymentsPanel && ActiveOrder is not null)
                        {
                            <MudPaper Elevation="1" Class="pa-2 mt-3">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Payments</MudText>
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mb-2">
                                    <MudSelect T="PaymentMethod" @bind-Value="NewPaymentMethod" Label="Method" Dense="true" Style="max-width:150px;">
                                        <MudSelectItem T="PaymentMethod" Value="PaymentMethod.Cash">Cash</MudSelectItem>
                                        <MudSelectItem T="PaymentMethod" Value="PaymentMethod.Card">Card</MudSelectItem>
                                        <MudSelectItem T="PaymentMethod" Value="PaymentMethod.GiftCard">Gift Card</MudSelectItem>
                                    </MudSelect>
                                    <MudTextField @bind-Value="NewPaymentAmount"
                                                  Label="Amount"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                                  Dense="true"
                                                  Immediate="true"
                                                  Style="max-width:180px;" />
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               Disabled="@(RemainingToPay <= 0 || !CanModifyActiveOrder)"
                                               OnClick="AddPayment">
                                        Add payment
                                    </MudButton>
                                    <MudButton Variant="Variant.Text" OnClick="@(() => ShowPaymentsPanel = false)">Close</MudButton>
                                </MudStack>
                                @if (ActiveOrder.Payments.Any())
                                {
                                    <MudTable Items="ActiveOrder.Payments" Dense="true" Hover="true">
                                        <HeaderContent>
                                            <MudTh>Method</MudTh>
                                            <MudTh>Amount</MudTh>
                                            <MudTh>Status</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Method">@context.Method</MudTd>
                                            <MudTd DataLabel="Amount">@context.Amount.ToString("C")</MudTd>
                                            <MudTd DataLabel="Status">
                                                <MudChip T="PaymentStatus" Color="Color.Success" Size="Size.Small" Variant="Variant.Outlined">@context.Status</MudChip>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">No payments yet.</MudText>
                                }
                            </MudPaper>
                        }
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="8">
                    <MudPaper Elevation="2" Class="pa-3 menu-panel">
                        <MudGrid>
                            <MudItem xs="12" md="9">
                                <MudTextField @bind-Value="SearchText"
                                              Placeholder="Search menu..."
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Class="mb-3"
                                              Immediate="true"
                                              Dense="true" />

                                <MudGrid GutterSize="2">
                                    @if (FilteredMenuItems.Any())
                                    {
                                        @foreach (var item in FilteredMenuItems)
                                        {
                                            <MudItem xs="12" sm="6" lg="4">
                                                <MudCard Class="menu-card" @onclick="() => AddItemToOrder(item)">
                                                    <MudCardContent>
                                                        <MudText Typo="Typo.subtitle1">@item.Name</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                                            @item.Description
                                                        </MudText>
                                                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">
                                                            @item.Price.ToString("C")
                                                        </MudChip>
                                                    </MudCardContent>
                                                </MudCard>
                                            </MudItem>
                                        }
                                    }
                                    else
                                    {
                                        <MudItem xs="12">
                                            <MudAlert Severity="Severity.Info">No dishes match your search.</MudAlert>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudStack Spacing="1" Class="category-stack">
                                    @foreach (var category in Categories)
                                    {
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="@GetCategoryColor(category)"
                                                   FullWidth="true"
                                                   Class="category-button"
                                                   OnClick="@(() => SelectCategory(category))">
                                            @category
                                        </MudButton>
                                    }
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
        else if (ActiveView == PortalView.Tables)
        {
            <MudPaper Elevation="2" Class="pa-4">
                <div class="d-flex align-center justify-space-between mb-4">
                    <MudText Typo="Typo.h5">Floor: Dining room</MudText>
                    <MudSelect T="TableStatus?" @bind-Value="TableStatusFilter" Label="Filter" Dense="true" Class="table-filter">
                        <MudSelectItem T="TableStatus?" Value="@((TableStatus?)null)">All</MudSelectItem>
                        <MudSelectItem T="TableStatus?" Value="TableStatus.Occupied">Occupied</MudSelectItem>
                        <MudSelectItem T="TableStatus?" Value="TableStatus.Reserved">Reserved</MudSelectItem>
                        <MudSelectItem T="TableStatus?" Value="TableStatus.Free">Free</MudSelectItem>
                    </MudSelect>
                </div>

                <MudGrid GutterSize="3">
                    @foreach (var table in FilteredTables)
                    {
                        <MudItem xs="6" sm="4" md="3">
                            <MudPaper Elevation="1"
                                      Class="@GetTableCardClass(table)"
                                      @onclick="() => SelectTable(table)">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle1">@table.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Seats @table.Capacity</MudText>
                                    <MudChip T="TableStatus" Color="@GetTableColor(table.Status)" Variant="Variant.Filled" Size="Size.Small">
                                        @table.Status
                                    </MudChip>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Secondary"
                                               Disabled="@(table.Status == TableStatus.Occupied)"
                                               OnClick="@(() => ToggleReservation(table))">
                                        @(table.Status == TableStatus.Reserved ? "Unreserve" : "Reserve")
                                    </MudButton>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-4">
                <div class="d-flex align-center justify-space-between mb-4">
                    <MudText Typo="Typo.h5">All orders</MudText>
                    <MudSelect T="OrderStatus?" @bind-Value="OrderStatusFilter" Label="Status" Dense="true" Class="status-filter">
                        <MudSelectItem T="OrderStatus?" Value="@((OrderStatus?)null)">All</MudSelectItem>
                        <MudSelectItem T="OrderStatus?" Value="OrderStatus.Open">Open</MudSelectItem>
                        <MudSelectItem T="OrderStatus?" Value="OrderStatus.Pending">Pending</MudSelectItem>
                        <MudSelectItem T="OrderStatus?" Value="OrderStatus.Closed">Closed</MudSelectItem>
                        <MudSelectItem T="OrderStatus?" Value="OrderStatus.Refunded">Refunded</MudSelectItem>
                    </MudSelect>
                </div>

                <MudTable Items="FilteredOrders" Hover="true" Dense="true" RowClick="OnOrderRowClick">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Table</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Total</MudTh>
                        <MudTh>Updated</MudTh>
                        <MudTh Style="width: 200px;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">@($"#{context.Id}")</MudTd>
                        <MudTd DataLabel="Table">@GetTableName(context.TableId)</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="OrderStatus" Color="@GetStatusColor(context.Status)" Variant="Variant.Outlined" Size="Size.Small">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Total">@CalculateTotal(context).ToString("C")</MudTd>
                        <MudTd DataLabel="Updated">
                            @((context.UpdatedAt ?? DateTime.UtcNow).ToLocalTime().ToString("g"))
                        </MudTd>
                        <MudTd>
                            <MudStack Row="true" Spacing="1">
                               <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           OnClick="@(() => ShowReceipt(context))">
                                   Receipt
                               </MudButton>
                                @if (CanRefund(context))
                                {
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               OnClick="@(() => RefundOrder(context))">
                                        Refund
                                    </MudButton>
                                }
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    }

    <MudPaper Elevation="1" Class="pa-2 mt-6 portal-nav">
        <MudGrid GutterSize="2">
            <MudItem xs="12" md="4">
                <MudButton FullWidth="true"
                           Variant="Variant.Filled"
                           Color="@GetNavColor(PortalView.CurrentOrder)"
                           OnClick="@(() => SwitchView(PortalView.CurrentOrder))">
                    Current order
                </MudButton>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudButton FullWidth="true"
                           Variant="Variant.Filled"
                           Color="@GetNavColor(PortalView.Tables)"
                           OnClick="@(() => SwitchView(PortalView.Tables))">
                    Tables
                </MudButton>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudButton FullWidth="true"
                           Variant="Variant.Filled"
                           Color="@GetNavColor(PortalView.AllOrders)"
                           OnClick="@(() => SwitchView(PortalView.AllOrders))">
                    All orders
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>
